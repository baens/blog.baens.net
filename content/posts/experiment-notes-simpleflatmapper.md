---
title: "Notes from experimenting with simpleflatmapper"
date: 2018-02-19
---

When I was a C# developer, I adored the different Micro-ORMs that were avaliable. If I can recall correctly, [Massive](https://github.com/FransBouma/Massive) was one of the first ones I heard about. The idea that I could just write straight SQL and get a list of objects out without any other configuration I loved. When I got back into Java, I always wondered if there were such a thing out there.

Well I've finally found a decent one. The library is called [Simpleflatmapper](http://simpleflatmapper.org/). With no XML configuration file, I can get from SQL to object with out any problem. This is amazing!

Let's see some code

In the examples I have a postgres database running with the following create table setup

```sql
CREATE TABLE test(id int GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, data text);
INSERT INTO test(data) VALUES('1'),('2'),('3'),('4');
```

So here is my first shot just trying to iterate over those

```kotlin
import com.zaxxer.hikari.HikariDataSource
import org.simpleflatmapper.jdbc.JdbcMapperFactory
import java.util.stream.Stream

fun main(args: Array<String>) {
    setupDataSource()

    getData().forEach { println(it) }
}

// Data class representing a row
data class DataRow(val id: Int, val data: String)

// Use this to pool connections
val dataSource = HikariDataSource()

/*
    This is the SimpleFlatMapper part. This creates a class 
    that knows how to map over the DataRow objects. This is needed because
    looking up certain fields and other reflection like tasks can be cached for
    performance reasons. So we have something that 
    can be smart about doing those for us
 */
val mapper = JdbcMapperFactory.newInstance().newMapper(DataRow::class.java)!!

fun setupDataSource() {
    dataSource.jdbcUrl = "jdbc:postgresql://localhost:5432/postgres"
    dataSource.username = "postgres"
    dataSource.password = "password"
}

fun getData() : Stream<DataRow> {
    val connection = dataSource.connection
    val statement = connection.prepareStatement("SELECT id, data FROM test")
    val resultSet = statement.executeQuery()
    return mapper.stream(resultSet)
}
```

If you ran this with everthing setup (repository here) you could see the following:

```
DataRow(id=1, data=1)
DataRow(id=2, data=2)
DataRow(id=3, data=3)
DataRow(id=4, data=4)
```

Neat!

But of course that isn't everything. We need to clean up after ourselves. Database connections in Java have a done of cruft that can be left over. What I'm talking about specifically in this case is the database connetions.

First let's experiment to see how bad the problem really is. 